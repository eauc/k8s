
* Links

Docker:
- [[https://docs.docker.com/registry/][Registry]]

Kubernetes
- [[https://kubernetes.io/docs/concepts/containers/images/][images]]
- [[https://kubernetes.io/docs/concepts/workloads/pods/][pods]]
- [[https://kubernetes.io/docs/concepts/services-networking/service/][services]]
- [[https://kubernetes.io/docs/concepts/storage/volumes/][volumes]]
- [[https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/][namespaces]]
- [[https://kubernetes.io/docs/concepts/workloads/controllers/deployment/][deployments]]
- [[https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/][jobs]]
- [[https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/][statefulsets]]
- [[https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/][daemonsets]]
- [[https://kubernetes.io/docs/concepts/configuration/overview/][configuration best practices]]
- [[https://docs.bitnami.com/kubernetes/how-to/configure-rbac-in-your-kubernetes-cluster/][RBAC config]]

KubeAdmin
- [[https://kubernetes.io/docs/setup/independent/install-kubeadm/][installation guide]]
- [[https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/][create cluster guide]]

Calico pod network provides
- [[https://docs.projectcalico.org/v3.2/getting-started/kubernetes/][getting started]]

[[https://www.linux.com/blog/learn/chapter/Intro-to-Kubernetes/2017/5/set-cicd-pipeline-kubernetes-part-1-overview][CI/CD with kubernetes]]
- [[https://github.com/kenzanlabs/kubernetes-ci-cd][Github repository]]
- [[https://github.com/kubernetes/kubernetes/issues/33664#issuecomment-292895327][Force redeploy with same image tag]]

Packages with Helm
- [[https://docs.helm.sh/using_helm][Using Helm]]
- [[https://docs.helm.sh/using_helm/#installing-helm][Installing Helm]]

Persistent volumes
- [[https://docs.storageos.com/docs/introduction/overview][StorageOS]]

* Installation notes

** VM configuration

- use =VM Network= for network adapter
- use manual MAC adress from =Perimetre d'exploitation= file

Ubuntu 18.04 image
- choose static IPv4 IP from =Perimetre d'exploitation= file

Docker v18 since v17.03 recommended by kudeamin is not found in docker repos.

** Kudeadmin

Kubeadmin does not work with swap:
#+BEGIN_SRC bash
swapoff -a
#+END_SRC
- edit =/etc/fstab= to remove swap entry

Kubeadmin install
- followed [[https://kubernetes.io/docs/setup/independent/install-kubeadm/][installation guide]]
- followed [[https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/][create cluster guide]]

** Calico

- kubeadmin cluster guide and calico getting started differs : the later install an additional etc-d cluster for calico
- followed calico [[https://docs.projectcalico.org/v3.2/getting-started/kubernetes/][getting started]]
#+BEGIN_SRC bash
watch kubectl get pods --all-namespaces
#+END_SRC
- some pods in NodeLost state during setup ???
- all pods running after ~1m

** Helm

- tiller requires roles definitions in the RBAC system, apply [[./helm/rbac-config.yaml][rbac-config]] before helm-init
- then call helm init with the ServiceAccount defined in RBAC config
#+BEGIN_SRC bash
helm init --service-account tiller
#+END_SRC
- if you already installed tiller and want to change this config afterwards:
#+BEGIN_SRC bash
helm init --service-account tiller --upgrade
#+END_SRC

** Prometheus

- [[https://medium.com/@timfpark/simple-kubernetes-cluster-monitoring-with-prometheus-and-grafana-dd27edb1641][simple tuto]]
- [[https://stackoverflow.com/questions/34282704/can-a-pvc-be-bound-to-a-specific-pv][bind pv to a specific pvc]]

** Grafana

- [[https://stackoverflow.com/questions/34282704/can-a-pvc-be-bound-to-a-specific-pv][bind pv to a specific pvc]]
- set rights for user 472:472 on pv directory =/data/grafana= otherwise grafana container dies when it can't create a subdirectory in it's volume :\

* Notes

Forward local port to push on distant docker registry with HTTP:
#+BEGIN_SRC bash
ssh -L <local-port>:<registry-ip>:<registry-port> <registry-host>
#+END_SRC

Misc
- [[https://stackoverflow.com/questions/34282704/can-a-pvc-be-bound-to-a-specific-pv][bind pv to a specific pvc]]
- [[https://stackoverflow.com/questions/39293441/needed-ports-for-kubernetes-cluster][ports used by clusters]]
- [[https://github.com/jetstack/kube-lego][kube-lego]]
